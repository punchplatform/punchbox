{
    "platform": {
        "platform_id": "punchplatform-primary",
        "setups_root": "{{ installation_directory }}",
        "remote_data_root_directory": "{{data_storage_directory}}",
        "remote_logs_root_directory": "/var/log/punchplatform",
        "punchplatform_daemons_user": "{{ operator.username }}",
        "punchplatform_group": "{{ operator.username }}",
        "binaries_version": "{{ version.binaries }}"
        {% if security is defined %}
        ,
        "platform_local_credentials_dir": "{{security.security_dir}}/platform_certs",
        "platform_ca_name": "ca.pem",
        "platform_truststore_name": "truststore.jks"
        {% endif %}
    },

    "reporters": {
      "myreporter" : {
        "type": "kafka",
        "brokers": "local",
        "topic": "platform-events",
        "reporting_interval": 30,
        "encoding": "json"
      }
   },

 
    {% if shiva is defined %}
    "shiva": {
    "shiva_version": "{{ version.shiva }}",
    "clusters": {
      "local": {
        "reporters" : ["myreporter"],
        "storage": {
          "type" : "{{ shiva.mode }}"
          {% if shiva.mode == "kafka" %}
          ,
          "kafka_cluster": "local"
          {% endif %}
        },
        {% if security is defined %}
        "ssl_enabled": true,
        {% endif %}
        "servers": {
        {% for server in shiva.servers %}
          "{{ server }}": {
            "runner": true,
            "can_be_master": true,
            "tags": [ "local" ],
            {% if security is defined %}
            "local_credentials_dir": "{{security.security_dir}}/platform_certs/{{server}}",
            "custom_additional_credentials_files": ["punchlines-keystore.jks", "truststore.jks"]
            {% endif %}
          }
      {% if not loop.last %}
      ,
      {% endif %}
      {% endfor %}
        }
      }
    }
  },
  {% endif %}
    {% if operator is defined %}
    "punchplatform_operator" : {
      "punchplatform_operator_environment_version": "{{ version.operator }}",
      "configuration_name_dir_from_home" : "pp-conf",
      "reporters" : ["myreporter"],
        {%- set temp_servers = [] %}
        {%- for server in zookeeper.servers %}
           {%- do temp_servers.append(server + ":2181/punchplatform-primary") %}
        {%- endfor %}
      "operators_username" : ["{{ operator.username }}"],
      "storage" : {
            "type" : "kafka",
            "kafka_cluster": "local"
      },
      "servers" : {
      {% for server in operator.servers %}
         "{{server}}" : {}
      }
      {% if not loop.last %}
          ,
        {% endif %}
      {% endfor %}
    },
    {% endif %}

    {% if spark is defined %}
   "spark" : {
    "spark_version" : "{{ version.spark }}",
    "punchplatform_analytics_deployment_version": "{{ version["analytics-deployment"] }}",
    "clusters" : {
      "local": {
        "master" : {
          "servers" : {{ spark.masters | tojson }},
          "listen_interface" : "{{ iface }}",
          "master_port" : 7077,
          "rest_port": 6066,
          "ui_port" : 8081
        },
        "slaves" : {
        {% for server in spark.slaves %}
          "{{ server }}" : {
            "listen_interface" : "{{ iface }}",
            "slave_port" : 7078,
            "webui_port" : 8084
          }
          {% if not loop.last %}
          ,
          {% endif %}
        {% endfor %}
        },
        {% if security is defined %}
        "servers":{
          {% for server in spark.slaves %}
          "{{server}}": {
            "local_credentials_dir": "{{security.security_dir}}/platform_certs/{{server}}",
            "custom_additional_credentials_files": ["punchlines-keystore.jks", "truststore.jks"]
          }{% if not loop.last %},{% endif %}
          {% endfor %}
        },
        {% endif %}
        "spark_workers_by_punchplatform_spark": 1,
        "zk_cluster" : "local",
        "zk_root" : "spark-main",
        "slaves_cpu" : 2,
        "slaves_memory" : "{{ spark.slaves_memory }}"
      }
    }
  },
   {% endif %}

   {% if zookeeper is defined %}
   "zookeeper": {
  "zookeeper_version": "{{ version.zookeeper }}",
   "zookeeper_nodes_production_interface": "{{ iface }}",
   "zookeeper_childopts": "{{ zookeeper.childopts }}",
   "zookeeper_admin_cluster_name": "local",
    "clusters": {
      "local": {
        "hosts": {{ zookeeper.servers | tojson }},
        "cluster_port": 2181,
        "punchplatform_root_node": "/punchplatform-primary",
        {% if security is defined %}
        "ssl_enabled": true,
        "zk_client_auth": "none",
        {% endif %}
        "servers": {
            {% for server in zookeeper.servers %}
            "{{server}}": {
                {% if security is defined %}
                "keystore_name": "{{server}}-keystore.jks"
                {% endif %}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
          }
      }
    }
    },

   {% endif %}

  {% if gateway is defined %}
  {% set server_ip = [] %}
  {% set port = "9200" %}
  {% for server in elasticsearch.servers  %}
  {% set server_ip = server_ip.append( server+":"+port ) %}
  {% endfor %}

  "gateway": {
    "gateway_version": "{{ version.gateway }}",
    "clusters": {
      "gateway_32g": {
        "tenant": "mytenant",
        "modsecurity_enabled": false,
        "servers": {
        {% for server in gateway.servers %}
          "{{ server }}": {
            "inet_address": "{{ gateway.inet_address }}",
            "port": 4242
            {% if security is defined %}
            ,
            "ssl": {
              "key_store_name": "{{server}}-keystore.jks",
              "key_store_type": "JKS",
              "key_alias": "{{server}}",
              "client_private_key_name": "{{server}}-key.pem",
              "client_certificate_name": "{{server}}-cert.pem"
            }
            {% endif %}
          }
        {% if not loop.last %}
          ,
        {% endif %}
      {% endfor %}
        },
        "elasticsearch": {
          "data_cluster": {
            "cluster_id": "es_search",
            "hosts" : {{ server_ip | tojson }},
            "settings": ["es.index.read.missing.as.empty: yes", "es.nodes.discovery: true"]
          },
          "metric_cluster": {
            "cluster_id": "es_search",
            "hosts": {{ server_ip | tojson }},
            "index_name": "mytenant-gateway-logs",
            "settings": ["es.index.read.missing.as.empty: yes", "es.nodes.discovery: true"]
          }
        },
        "resources": {
          "doc_dir": "{{ installation_directory }}/punchplatform-documentation-{{version.gateway}}/doc/html",
          "punchlines_dir": "punchlines/mytenant",
          "archives_dir": "/tmp",
          "manager": {
            "metadata": [
              {
                "type": "elasticsearch",
                "hosts": {{ server_ip | tojson }},
                "index": "resources-metadata"
              }
            ],
            "data": [
              {
                "type": "file",
                "root_path": "/tmp/punchplatform/resources"
              }
            ]
          }
        },
        "reporters": ["myreporter"]
      }
    }
  },
   {% endif %}

   {% if kafka is defined %}
   "kafka" : {
   "kafka_version" : "{{ version.kafka }}",
   "kafka_brokers_production_interface" : "{{ iface }}",
    "clusters" : {
      "local" : {
        "brokers_with_ids" : [
              {%- for broker in kafka.brokers %}
              {
                "id" : {{ loop.index }},
                "broker" : "{{broker}}"
                {% if security is defined %}
                ,
                "keystore_name": "{{broker | url_to_host }}-keystore.jks"
                {% endif %}
              }
              {% if not loop.last %}
              ,
              {% endif %}
              {%- endfor %}
        ],
        {% if security is defined %}
        "ssl_enabled": true,
        {% endif %}
        "zk_cluster" : "local",
        "zk_root" : "kafka-local",
        "brokers_config" : "punchplatform-local-server.properties",
        "default_replication_factor" : 1,
        "default_partitions" : 2,
        "partition_retention_bytes" : 1073741824,
        "partition_retention_hours" : 24,
        "kafka_brokers_jvm_xmx": "{{ kafka.jvm_xmx }}"
      }
    }
  },
   {% endif %}

   {% if elasticsearch is defined %}
   "elasticsearch" : {
    "elasticsearch_version" : "{{ version.elastic }}",
    "clusters" : {
      "es_search" : {
        "nodes" : {
          {% for server in elasticsearch.servers %}
          "{{ server }}" : {
            "http_api_address" : "{{ server }}",
            "transport_address" : "{{ server }}",
            "bind_address" : "_{{ iface }}_",
            "rack_id" : "{{ loop.index }}"
            {% if security is defined %}
            ,
            "admin_pemkey_name": "admin-{{server}}-key.pem",
            "admin_pemcert_name": "admin-{{server}}-cert.pem",
            "ssl_pemkey_name": "{{server}}-key.pem",
            "ssl_pemcert_name": "{{server}}-cert.pem"
            {% endif %}
          }
          {% if not loop.last %}
          ,
          {% endif %}
          {% endfor %}
        },
        "http_api_port" : 9200,
        "cluster_production_transport_address" : "{{ elasticsearch.cluster_production_transport_address }}",
        "transport_port" : 9300,
        "minimum_master_nodes": {{ elasticsearch.servers|length }},
        "settings_by_type" : {
          "data_node": {
            "max_memory": "{{ elasticsearch.memory }}",
            "modsecurity_enabled": false,
            "modsecurity_blocking_requests": false,
            "script_execution_authorized": true,
            "http_cors_enabled" : true,
            "readonly" : true
          }
        }
        {% if security is defined %}
        ,
        "plugins":{
          "opendistro_security": {
            "opendistro_security_version": "{{ version.opendistro_security }}",
            "ssl_http_enabled": true,
            "authcz_admin_dn": [
              "emailAddress=admin-server2-super-1@easyssl.com,CN=server2,OU=AC,O=EasySslCorp,L=Paris,ST=IdF,C=FR",
              "emailAddress=admin-server3-super-1@easyssl.com,CN=server3,OU=AC,O=EasySslCorp,L=Paris,ST=IdF,C=FR"
            ],
            "nodes_dn": [
              "emailAddress=server2-super-1@easyssl.com,CN=server2,OU=AC,O=EasySslCorp,L=Paris,ST=IdF,C=FR",
              "emailAddress=server3-super-1@easyssl.com,CN=server3,OU=AC,O=EasySslCorp,L=Paris,ST=IdF,C=FR"
            ],
            "kibana_index": ".kibana-admin"
          }
        }
        {% endif %}
      }
    }
  },
   {% endif %}

   {% if storm is defined %}
   "storm" : {
   "storm_version" : "{{ version.storm }}",
   "storm_nimbus_nodes_production_interface" : "{{ iface }}",
    "clusters" : {
      "local": {
        "master" : {
          "servers" : {{ storm.master.servers | tojson }},
          "cluster_production_address" : "{{ storm.master.cluster_production_address }}"
        },
        "ui" : {
          "servers" : {{ storm.ui.servers | tojson }},
          "cluster_admin_url": "{{ storm.ui.cluster_admin_url }}:8080"
        },
        "slaves" : {{ storm.slaves | tojson }},
        "zk_cluster" : "local",
        "zk_root" : "storm-1.2.2-main",
        "storm_workers_by_punchplatform_supervisor" : 10,
        "workers_childopts" : "{{ storm.workers_childopts }}",
        "supervisor_memory_mb" : {{ storm.supervisor_memory_mb }},
        "supervisor_cpu" : 2
      }
    }
  },
   {% endif %}

   {% if minio is defined %}
   "minio": {
    "minio_version": "{{ version.minio }}",
    "minio_access_key": "admin",
    "minio_secret_key": "punchplatform",
      "clusters": {
        "local": {
          "hosts": {{ minio.servers | tojson }},
          "port": "9000"
        }
      }
    },
   {% endif %}

   {% if clickhouse is defined %}
  "clickhouse": {
    "clickhouse_version": "20.4.6.53",
    "clusters": {
      "common": {
        "shards": [
          {
            "servers": {{ clickhouse.servers | tojson }}
          }
        ],
        "zk_cluster": "local",
        "zk_root": "clickhouse",
        "http_port": 8123,
        "tcp_port": 9100
      }
    }
  },
   {% endif %}

  {% if kibana is defined %}
  "kibana" : {
  "kibana_version" : "{{ version.elastic }}",
    "domains" : {
      "admin" : {
        "gateway_cluster_target": "gateway_32g",
        "kibana_port" : 5601,
        "type" : "administration"
        {% if security is defined %}
        ,
        "server_ssl_enabled": true,
        "server_ssl_key_name": "server1-key.pem",
        "server_ssl_certificate_name": "server1-cert.pem",
        "elasticsearch_ssl_enabled": true,
        "elasticsearch_ssl_verificationMode": "full",
        "elasticsearch_ssl_certificateAuthorities_names": ["ca.pem"]
        {% endif %}
        {% if gateway is defined %}
        {% set server_ip = [] %}
        {% set port = "4242" %}
        {% if security is defined %}{% set scheme = "https" %}{% else %}{% set scheme = "http" %}{% endif %}
        {% for server in gateway.servers  %}
        {% set server_ip = server_ip.append( scheme + "://"+server+":"+port ) %}
        {% endfor %}
        ,
        "plugins":{
          "punchplatform": {
            "rest_api": {
              "hosts": {{ server_ip | tojson }}
              {% if security is defined %}
              ,
              "ssl_enabled": true
              {% endif %}
            }
          }
        }
        {% endif %}
      }
    },
    "servers" : {
    {% for server in kibana.servers %}
      "{{ server }}" : {
        "address" : "{{ server }}"
      }{% if not loop.last %},{% endif %}
    {% endfor %}
    },
    "plugins":{
    "punchplatform": {
        "punchplatform_version": "{{ version.punch }}"
      },
      "punchplatform_feedback": {
        "punchplatform_feedback_version": "{{ version.punch }}"
      }
      {% if security is defined %}
      ,
      "opendistro_security": {
        "opendistro_security_version": "{{ version.opendistro_security }}"
      },
      "opendistro_alerting": {
        "opendistro_alerting_version": "{{ version.opendistro_security }}"
      }
      {% endif %}
    }
  },
    {% endif %}

    "metricbeat" : {
    "metricbeat_version" : "{{ version.metricbeat }}",
    "servers": {
        {% for server in metricbeat.servers %}
        "{{server}}": {
            {% if security is defined %}
            "private_key_name": "{{server}}-key.pem",
            "certificate_name": "{{server}}-cert.pem"
            {% endif %}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    },
    "modules" : {
      "system" : {
        "high_frequency_system_metrics": {
          "metricsets" : ["cpu","load","memory"],
          "reporting_interval" : "30s"
        },
        "normal_frequency_system_metrics": {
          "metricsets" : ["fsstat"],
          "reporting_interval" : "5m"
        },
        "slow_frequency_system_metrics": {
          "metricsets" : ["uptime"],
          "reporting_interval" : "1h"
        }
      }
    },
    "elasticsearch" : {
      "cluster_id" : "es_search"
      {% if security is defined %}
      ,
      "ssl_enabled": true
      {% endif %}
    }
  }

}